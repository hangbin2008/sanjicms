name: Build and Push Docker Image

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    # 检查代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 设置Go环境
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    # 安装依赖
    - name: Install dependencies
      run: |
        go mod tidy
        go mod download

    # 运行测试
    - name: Run tests
      run: go test ./...

    # 构建Go应用
    - name: Build Go application
      run: go build -o main ./cmd/server

    # 设置Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 登录GitHub Container Registry
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 构建并推送Docker镜像
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/hangbin2008/sanjicms:latest
          ghcr.io/hangbin2008/sanjicms:${{ github.sha }}
        platforms: linux/amd64,linux/arm64
        labels: |
          org.opencontainers.image.source=https://github.com/hangbin2008/sanjicms
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.version=latest
        provenance: false
        sbom: false
    
    # 检查镜像是否成功推送
    - name: Check pushed image
      run: |
        echo "Checking pushed images..."
        echo "Image 1: ghcr.io/hangbin2008/sanjicms:latest"
        echo "Image 2: ghcr.io/hangbin2008/sanjicms:${{ github.sha }}"

    # 输出构建结果
    - name: Echo build result
      run: echo "Docker image built and pushed to GitHub Container Registry (ghcr.io)"
    
    # 清理旧工作流运行，只保留最近5个
    - name: Clean old workflow runs
      uses: actions/github-script@v7
      with:
        script: |
          // 修复：使用listWorkflowRuns获取所有运行，不依赖特定工作流ID
          const runs = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          // 只保留最近5个运行，删除旧运行
          if (runs.data.workflow_runs.length > 5) {
            console.log(`找到 ${runs.data.workflow_runs.length} 个工作流运行，将删除除最近5个以外的所有运行`);
            
            // 获取要删除的运行（除了前5个）
            const runsToDelete = runs.data.workflow_runs.slice(5);
            
            // 按时间顺序删除（先删除最旧的）
            for (const run of runsToDelete.reverse()) {
              try {
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                console.log(`已删除工作流运行: ${run.id} (${run.created_at})`);
              } catch (error) {
                console.error(`删除工作流运行 ${run.id} 失败: ${error.message}`);
              }
            }
            
            console.log(`清理完成，保留了最近5个工作流运行`);
          } else {
            console.log(`工作流运行数量 (${runs.data.workflow_runs.length}) 不超过5个，无需清理`);
          }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
